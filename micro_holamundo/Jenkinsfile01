pipeline {
    agent any
    tools {
        gradle 'Gradle 7.5.1' 
     }
    stages {   
        stage('Build') {
            steps {
                 checkout scmGit(branches: [[name: '*/master']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/Taranator0813/Proyecto_Semilleros.git']])
                script{
                 sh """
                    cd micro_holamundo
                    gradle init
                    gradle build
                    """
                }
            }
        }

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        stage('Pruebas de API con Newman') {
            agent {
                label "slave"
            } 
            steps {
                script {
                
                    def newmanExitCode = sh(script: "newman run micro_holamundo/JSON_Postman/NewCollection.postman_collection.json", returnStatus: true)
                    echo "status " + newmanExitCode

                    if (newmanExitCode != 0) {
                    env.STATUS = 1
                    echo "¡Falló la prueba de API con Newman! Código de salida " + newmanExitCode
                    }
                    else {
                    env.STATUS = 0
                    echo "¡Prueba de API con Newman exitosa! Código de salida " + newmanExitCode
                    }
                
                }
            }
        }

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        stage('Rollback') {
            when {
                expression { env.STATUS == "1" }
            }
            steps {
                script {
                echo "Realizando rollback..."
                
                sh """
                    az login --service-principal --username 2d721c5d-feae-41c7-a45a-ac923780104a --password yga8Q~gCRhayv9xO0f55Pb996MbCIReGZWQJ9dsX --tenant c5ad2df2-752b-4501-9b44-db6c637f5221
                    az account set --subscription af4e92ac-7566-4412-8a79-e11fc3a89f24
                    az aks get-credentials --resource-group Proyecto_DevOps --name stack_Banc_Pop2504-k8s
                    cd micro_holamundo/k8s
                    ls -la 
                    kubectl rollout undo deployment.v1.apps/rest -n ms
                    kubectl describe deployment rest -n ms                   
                    """
                    echo "Falló la ejecución de la prueba. Se realizó un rollback a la versión anterior de la imagen."
                }
            }
        }

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        stage('Creación Directorio') {
            agent {
                label "slave"
            } 
            steps {
                  sh"""
                     pwd
                     cd 
                     ls -la
                     cd /home/
                     sudo mkdir -p nuevo-directorio
                     sudo chmod 777 nuevo-directorio
                    """
            
            }
        }
     
   //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        stage('Git Clone') {
            agent {
                label "slave"
            } 
            steps {
                sh "git clone https://github.com/Taranator0813/Proyecto_Semilleros.git /home/nuevo-directorio"
                 withEnv(['JMETER_HOME=/home/apache-jmeter-5.5']) {
                    sh "${env.JMETER_HOME}/bin/jmeter -n -t /home/nuevo-directorio/micro_holamundo/JMETER/ejemplob.jmx -l /home/nuevo-directorio/micro_holamundo/JMETER/resultado0906.jtl"
                    //-e -o /home/nuevo-directorio/micro_holamundo/JMETER/ResultadosHTML
                    //sh 'cp /home/nuevo-directorio/micro_holamundo/JMETER/ResultadosHTML/index.html $WORKSPACE/index.html'
                    //sh "${env.JMETER_HOME}/bin/jmeter --nongui --plugin-type AggregateReport --generate-csv /home/nuevo-directorio/micro_holamundo/JMETER/resultados.csv --input-jtl /home/nuevo-directorio/micro_holamundo/JMETER/resultadosss.jtl --plugin-type AggregateReport --report-output /home/nuevo-directorio/micro_holamundo/JMETER/reporte"
                    sh "${env.JMETER_HOME}/bin/jmeter -n -t /home/nuevo-directorio/micro_holamundo/JMETER/ejemplob.jmx -l /home/nuevo-directorio/micro_holamundo/JMETER/resultado0906.xml "
                    sh "${env.JMETER_HOME}/bin/jmeter -g /home/nuevo-directorio/micro_holamundo/JMETER/resultado0906.xml -o /home/nuevo-directorio/micro_holamundo/JMETER/ResultadosHTML"
        		    sh "zip -r informacion-${BUILD_NUMBER}.zip /home/nuevo-directorio/micro_holamundo/JMETER/ResultadosHTML"
                    //sh "tar -czf informacion-${BUILD_NUMBER}.tar.gz /home/nuevo-directorio/micro_holamundo/JMETER/ResultadosHTML"

                 }
            }
        }
        
  
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
     
        stage('Enviar por correo') {
          agent {
            label "slave"
          }
          
          steps {
            script {
              
               emailext body: 'Adjunto el archivo HTML generado por las pruebas JMeter.',
                          subject: 'Resultado de las pruebas JMeter',
                          attachmentsPattern: 'informacion-${BUILD_NUMBER}.zip',
                          to: 'munoze297@gmail.com'
            
            }
          }
        }   
   
         
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        stage('performance') {
            agent {
                label "slave"
            } 
            steps {
                perfReport filterRegex: '', sourceDataFiles: '/home/nuevo-directorio/micro_holamundo/JMETER/resultado0906.xml'           
            }
        }
            
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    }
}

